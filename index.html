<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My 5-Day Workout & 5K Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark ::-webkit-scrollbar-track {
            background: #333;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #555;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-200 dark:from-gray-800 dark:to-gray-950 text-gray-900 dark:text-gray-100 p-4 sm:p-6 lg:p-8">

    <!-- Modal Message Container -->
    <div id="modal-message-container" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="modal-message-text" class="text-lg mb-4"></p>
            <button id="modal-message-ok-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 ease-in-out">
                OK
            </button>
        </div>
    </div>

    <header class="text-center mb-8">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-blue-700 dark:text-blue-400 mb-2">
            My 5-Day Workout & 5K Tracker
        </h1>
        <p class="text-lg sm:text-xl text-gray-600 dark:text-gray-300">
            Stay consistent, build muscle, and improve your 5K!
        </p>
        <p id="user-id-display" class="text-sm text-gray-500 dark:text-gray-400 mt-2">
            User ID: Loading...
        </p>
    </header>

    <!-- Daily Workout Section -->
    <section id="daily-workout-section" class="mb-10 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
        <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-200 mb-4 flex items-center">
            <svg class="w-7 h-7 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            Today's Workout: <span id="today-date-display"></span>
        </h2>
        <div id="daily-workout-content">
            <!-- Content will be loaded by JavaScript -->
            <p class="text-gray-700 dark:text-gray-300">Loading today's workout...</p>
        </div>
    </section>

    <!-- Active Workout Session -->
    <section id="active-workout-section" class="mb-10 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 hidden">
        <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-200 mb-4 flex items-center">
            <svg class="w-7 h-7 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M3 19l6 3V6m0 0l-6 3m6 0l-12 3"></path></svg>
            Workout In Progress
        </h2>
        <div id="active-workout-content" class="text-center">
            <p id="exercise-progress" class="text-lg text-gray-600 dark:text-gray-300 mb-2"></p>
            <h3 id="current-exercise-name" class="text-3xl font-bold text-blue-700 dark:text-blue-400 mb-4"></h3>
            <p id="current-exercise-details" class="text-gray-700 dark:text-gray-300 mb-4"></p>
            <img id="current-exercise-image" src="" alt="Exercise Image" class="mx-auto rounded-lg shadow-md mb-6 w-full max-w-md h-auto object-cover" onerror="this.onerror=null; this.src='https://placehold.co/300x200/CCCCCC/000000?text=Image+Not+Found';">

            <div class="mb-4">
                <label for="weightInput" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                    Weight Used (kg/lbs):
                </label>
                <input
                    type="number"
                    id="weightInput"
                    class="shadow appearance-none border rounded-full w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600 max-w-xs mx-auto"
                    placeholder="e.g., 20"
                />
            </div>

            <div id="rest-timer-display" class="text-xl font-semibold text-red-500 mb-4 hidden">
                Rest Timer: <span id="timer-seconds">0</span> seconds
            </div>

            <button id="done-exercise-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform hover:scale-105 transition duration-300 ease-in-out">
                Done
            </button>
        </div>
    </section>

    <!-- Workout Logging Section -->
    <section id="logging-section" class="mb-10 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 hidden">
        <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-200 mb-4 flex items-center">
            <svg class="w-7 h-7 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
            Log Your Workout
        </h2>
        <div class="mb-4">
            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                Overall Workout Rating:
            </label>
            <div id="workout-rating-stars" class="flex justify-center space-x-2">
                <!-- Stars will be populated by JavaScript -->
            </div>
        </div>
        <div class="mb-4">
            <label for="workoutComment" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">
                Comments (Optional):
            </label>
            <textarea
                id="workoutComment"
                class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600 h-24 resize-none"
                placeholder="How was your workout today?"
            ></textarea>
        </div>
        <button id="submit-log-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform hover:scale-105 transition duration-300 ease-in-out">
            Submit Log
        </button>
    </section>

    <!-- Weight Progress Section -->
    <section id="weight-progress-section" class="mb-10 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
        <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-200 mb-4 flex items-center">
            <svg class="w-7 h-7 mr-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
            Your Weight Progress
        </h2>
        <div id="weight-progress-content" class="overflow-x-auto">
            <!-- Content will be loaded by JavaScript -->
            <p class="text-gray-700 dark:text-gray-300">Loading weight progress...</p>
        </div>
    </section>

    <!-- Workout History Section -->
    <section id="workout-history-section" class="p-6 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
        <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-200 mb-4 flex items-center">
            <svg class="w-7 h-7 mr-2 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
            Workout History
        </h2>
        <div id="workout-history-content" class="space-y-4">
            <!-- Content will be loaded by JavaScript -->
            <p class="text-gray-700 dark:text-gray-300">Loading workout history...</p>
        </div>
    </section>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Utility to get current day of the week (0 for Sunday, 1 for Monday, etc.)
        const getDayOfWeek = (date) => {
            const d = new Date(date);
            return d.getDay(); // 0 (Sunday) to 6 (Saturday)
        };

        const getTodayDateString = () => {
            const today = new Date();
            return today.toISOString().split('T')[0]; // YYYY-MM-DD
        };

        // Exercise data with placeholder images
        const EXERCISES_DATA = [
            { id: 'dumbbell-floor-press', name: 'Dumbbell Floor Press', imageUrl: 'https://placehold.co/300x200/000000/FFFFFF?text=Dumbbell+Floor+Press', description: '3 sets x 10–12 reps' },
            { id: 'standing-dumbbell-upward-fly', name: 'Standing Dumbbell Upward Fly', imageUrl: 'https://placehold.co/300x200/000000/FFFFFF?text=Standing+Dumbbell+Upward+Fly', description: '3 sets x 10–12 reps' },
            { id: 'dumbbell-push-up', name: 'Dumbbell Push-Up', imageUrl: 'https://placehold.co/300x200/000000/FFFFFF?text=Dumbbell+Push-Up', description: '3 sets x 8–12 reps' },
            { id: 'seated-shoulder-press', name: 'Seated Shoulder Press (on chair)', imageUrl: 'https://placehold.co/300x200/000000/FFFFFF?text=Seated+Shoulder+Press', description: '3 sets x 10–12 reps' },
            { id: 'standing-svend-press', name: 'Standing Svend Press', imageUrl: 'https://placehold.co/300x200/000000/FFFFFF?text=Standing+Svend+Press', description: '2 sets x 12–15 reps' },
            { id: 'seated-bicep-curl', name: 'Seated Bicep Curl (on chair)', imageUrl: 'https://placehold.co/300x200/000000/FFFFFF?text=Seated+Bicep+Curl', description: '2 sets x 12–15 reps' },
            { id: 'seated-tricep-extension', name: 'Seated Tricep Extension (on chair)', imageUrl: 'https://placehold.co/300x200/000000/FFFFFF?text=Seated+Tricep+Extension', description: '2 sets x 12–15 reps' },
            { id: 'easy-jog', name: 'Easy Jog', imageUrl: 'https://placehold.co/300x200/000000/FFFFFF?text=Easy+Jog', description: '7 min warm-up / 7 min cool-down' },
            { id: 'dynamic-stretches', name: 'Dynamic Stretches', imageUrl: 'https://placehold.co/300x200/000000/FFFFFF?text=Dynamic+Stretches', description: 'Warm-up' },
            { id: '400m-intervals', name: '400m Intervals', imageUrl: 'https://placehold.co/300x200/000000/FFFFFF?text=400m+Intervals', description: '4–5 x 400m at target pace (2 min per rep), 90 sec walk/jog rest' },
            { id: 'goblet-squat', name: 'Goblet Squat', imageUrl: 'https://placehold.co/300x200/000000/FFFFFF?text=Goblet+Squat', description: '3 sets x 8–12 reps' },
            { id: 'stiff-leg-deadlift', name: 'Stiff-Leg Deadlift', imageUrl: 'https://placehold.co/300x200/000000/FFFFFF?text=Stiff-Leg+Deadlift', description: '3 sets x 8–12 reps' },
            { id: 'dumbbell-lunge', name: 'Dumbbell Lunge', imageUrl: 'https://placehold.co/300x200/000000/FFFFFF?text=Dumbbell+Lunge', description: '2 sets x 10 reps per leg' },
            { id: 'calf-raise', name: 'Calf Raise', imageUrl: 'https://placehold.co/300x200/000000/FFFFFF?text=Calf+Raise', description: '2 sets x 15 reps' },
            { id: 'continuous-run', name: 'Continuous Run', imageUrl: 'https://placehold.co/300x200/000000/FFFFFF?text=Continuous+Run', description: '20–25 min at a steady pace' },
            { id: 'dumbbell-squat', name: 'Dumbbell Squat', imageUrl: 'https://placehold.co/300x200/000000/FFFFFF?text=Dumbbell+Squat', description: '3 sets x 8–12 reps' },
            { id: 'dumbbell-deadlift', name: 'Dumbbell Deadlift', imageUrl: 'https://placehold.co/300x200/000000/FFFFFF?text=Dumbbell+Deadlift', description: '3 sets x 8–12 reps' },
            { id: 'dumbbell-row', name: 'Dumbbell Row', imageUrl: 'https://placehold.co/300x200/000000/FFFFFF?text=Dumbbell+Row', description: '3 sets x 8–12 reps' },
            { id: 'dumbbell-press', name: 'Dumbbell Press', imageUrl: 'https://placehold.co/300x200/000000/FFFFFF?text=Dumbbell+Press', description: '3 sets x 8–12 reps' },
            { id: 'hiit-run', name: 'HIIT Run', imageUrl: 'https://placehold.co/300x200/000000/FFFFFF?text=HIIT+Run', description: '10 min (30s fast/30s recovery, repeat 10x)' },
        ];

        // Workout plan definition
        const WORKOUT_PLAN = {
            1: { // Monday
                name: 'Upper Body Strength (No Bench Needed)',
                exercises: [
                    { id: 'dumbbell-floor-press', sets: 3, reps: '10–12' },
                    { id: 'standing-dumbbell-upward-fly', sets: 3, reps: '10–12' },
                    { id: 'dumbbell-push-up', sets: 3, reps: '8–12' },
                    { id: 'seated-shoulder-press', sets: 3, reps: '10–12' },
                    { id: 'standing-svend-press', sets: 2, reps: '12–15' },
                    { id: 'seated-bicep-curl', sets: 2, reps: '12–15' },
                    { id: 'seated-tricep-extension', sets: 2, reps: '12–15' },
                ],
                rest: '45–60 seconds between sets',
                time: '35–40 min',
            },
            2: { // Tuesday
                name: 'Speed Intervals (5K Pace)',
                exercises: [
                    { id: 'easy-jog', description: 'Warm-up: 7 min easy jog' },
                    { id: 'dynamic-stretches', description: 'Warm-up: Dynamic stretches' },
                    { id: '400m-intervals', description: 'Main Set: 4–5 x 400m at target pace (2 min per rep), 90 sec walk/jog rest' },
                    { id: 'easy-jog', description: 'Cool-down: 7 min easy jog' },
                ],
                rest: 'Focus on running each interval at your goal 5K pace.',
                time: '38 min',
            },
            3: { // Wednesday
                name: 'Lower Body Strength',
                exercises: [
                    { id: 'goblet-squat', sets: 3, reps: '8–12' },
                    { id: 'stiff-leg-deadlift', sets: 3, reps: '8–12' },
                    { id: 'dumbbell-lunge', sets: 2, reps: '10 per leg' },
                    { id: 'calf-raise', sets: 2, reps: '15' },
                ],
                rest: '60 seconds between sets',
                time: '28 min',
            },
            4: { // Thursday
                name: 'Tempo/Steady-State Run',
                exercises: [
                    { id: 'continuous-run', description: 'Continuous Run: 20–25 min at a steady pace (just slower than goal 5K pace)' },
                    { id: 'easy-jog', description: 'Optional: 5 min easy jog to cool down' },
                ],
                rest: 'Keep the pace controlled—focus on endurance and running form.',
                time: '25 min',
            },
            5: { // Friday
                name: 'Full Body Strength + HIIT',
                exercises: [
                    { id: 'dumbbell-squat', sets: 3, reps: '8–12' },
                    { id: 'dumbbell-deadlift', sets: 3, reps: '8–12' },
                    { id: 'dumbbell-row', sets: 3, reps: '8–12' },
                    { id: 'dumbbell-press', sets: 3, reps: '8–12' },
                    { id: 'hiit-run', description: 'HIIT Run: 10 min (30s fast/30s recovery, repeat 10x)' },
                ],
                rest: '60 seconds between sets. Move efficiently to stay within 45 minutes.',
                time: '45 min',
            },
        };

        // UI State Variables
        let currentDay;
        let activeWorkout = null; // null, 'planning', 'in-progress', 'logging'
        let currentExerciseIndex = 0;
        let timer = 0;
        let timerActive = false;
        let workoutLog = {};
        let workoutRating = 0;
        let workoutComment = '';
        let weightInput = '';
        let weightLogs = [];
        let workoutHistory = [];
        let showMessage = null; // For custom modal messages

        const todayDate = getTodayDateString();
        let workoutForToday; // Will be set after currentDay is determined

        // DOM Elements
        const dailyWorkoutSection = document.getElementById('daily-workout-section');
        const dailyWorkoutContent = document.getElementById('daily-workout-content');
        const activeWorkoutSection = document.getElementById('active-workout-section');
        const activeWorkoutContent = document.getElementById('active-workout-content');
        const loggingSection = document.getElementById('logging-section');
        const weightProgressSection = document.getElementById('weight-progress-section');
        const weightProgressContent = document.getElementById('weight-progress-content');
        const workoutHistorySection = document.getElementById('workout-history-section');
        const workoutHistoryContent = document.getElementById('workout-history-content');
        const userIdDisplay = document.getElementById('user-id-display');
        const todayDateDisplay = document.getElementById('today-date-display');

        const startWorkoutBtn = document.getElementById('start-workout-btn');
        const doneExerciseBtn = document.getElementById('done-exercise-btn');
        const submitLogBtn = document.getElementById('submit-log-btn');
        const weightInputEl = document.getElementById('weightInput');
        const workoutCommentEl = document.getElementById('workoutComment');
        const workoutRatingStarsEl = document.getElementById('workout-rating-stars');
        const restTimerDisplay = document.getElementById('rest-timer-display');
        const timerSecondsSpan = document.getElementById('timer-seconds');

        const modalMessageContainer = document.getElementById('modal-message-container');
        const modalMessageText = document.getElementById('modal-message-text');
        const modalMessageOkBtn = document.getElementById('modal-message-ok-btn');

        // Helper to find exercise details
        const getExerciseDetails = (id) => EXERCISES_DATA.find(ex => ex.id === id);

        // --- Modal Message Functions ---
        const showModalMessage = (message) => {
            showMessage = message;
            modalMessageText.textContent = message;
            modalMessageContainer.classList.remove('hidden');
        };

        const hideModalMessage = () => {
            showMessage = null;
            modalMessageContainer.classList.add('hidden');
        };

        // --- Render Functions ---
        const renderDailyWorkout = () => {
            todayDateDisplay.textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            if (workoutForToday) {
                let html = `
                    <h3 class="text-xl sm:text-2xl font-semibold text-blue-600 dark:text-blue-300 mb-3">${workoutForToday.name}</h3>
                    <p class="text-gray-700 dark:text-gray-300 mb-2">Est. Time: ${workoutForToday.time}</p>
                    <p class="text-gray-700 dark:text-gray-300 mb-4">Rest: ${workoutForToday.rest}</p>
                    <ul class="space-y-3 mb-6">
                `;
                workoutForToday.exercises.forEach((ex, index) => {
                    const details = getExerciseDetails(ex.id);
                    html += `
                        <li class="flex items-center text-gray-800 dark:text-gray-200">
                            <svg class="w-5 h-5 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                            ${details ? details.name : ex.id} ${ex.sets ? `${ex.sets} sets x ${ex.reps}` : ''} ${ex.description ? `(${ex.description})` : ''}
                        </li>
                    `;
                });
                html += `</ul>`;

                if (activeWorkout === null) {
                    html += `
                        <button id="start-workout-btn-dynamic" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform hover:scale-105 transition duration-300 ease-in-out">
                            Start Workout
                        </button>
                    `;
                }
                dailyWorkoutContent.innerHTML = html;

                // Re-attach event listener for the dynamically created button
                const dynamicStartBtn = document.getElementById('start-workout-btn-dynamic');
                if (dynamicStartBtn) {
                    dynamicStartBtn.onclick = startWorkout;
                }

            } else {
                dailyWorkoutContent.innerHTML = '<p class="text-gray-700 dark:text-gray-300">No scheduled workout for today. Enjoy your rest day!</p>';
            }
        };

        const renderActiveWorkout = () => {
            if (activeWorkout === 'in-progress' && workoutForToday && currentExerciseIndex < workoutForToday.exercises.length) {
                activeWorkoutSection.classList.remove('hidden');
                dailyWorkoutSection.classList.add('hidden');
                loggingSection.classList.add('hidden');

                const currentExercise = workoutForToday.exercises[currentExerciseIndex];
                const details = getExerciseDetails(currentExercise.id);

                document.getElementById('exercise-progress').textContent = `Exercise ${currentExerciseIndex + 1} of ${workoutForToday.exercises.length}`;
                document.getElementById('current-exercise-name').textContent = details?.name || currentExercise.id;
                document.getElementById('current-exercise-details').textContent =
                    `${currentExercise.sets ? `${currentExercise.sets} sets x ${currentExercise.reps}` : ''} ${currentExercise.description ? `(${currentExercise.description})` : ''}`;
                document.getElementById('current-exercise-image').src = details?.imageUrl || 'https://placehold.co/300x200/CCCCCC/000000?text=Image+Not+Found';
                weightInputEl.value = weightInput;

                if (timerActive) {
                    restTimerDisplay.classList.remove('hidden');
                    timerSecondsSpan.textContent = timer;
                } else {
                    restTimerDisplay.classList.add('hidden');
                }
            } else {
                activeWorkoutSection.classList.add('hidden');
            }
        };

        const renderLoggingSection = () => {
            if (activeWorkout === 'logging' && workoutForToday) {
                loggingSection.classList.remove('hidden');
                dailyWorkoutSection.classList.add('hidden');
                activeWorkoutSection.classList.add('hidden');

                // Render stars
                workoutRatingStarsEl.innerHTML = '';
                for (let i = 1; i <= 5; i++) {
                    const starBtn = document.createElement('button');
                    starBtn.textContent = '★';
                    starBtn.classList.add('text-3xl', 'transition-colors', 'duration-200');
                    if (i <= workoutRating) {
                        starBtn.classList.add('text-yellow-400');
                    } else {
                        starBtn.classList.add('text-gray-400');
                    }
                    starBtn.dataset.rating = i;
                    starBtn.onclick = (e) => {
                        setWorkoutRating(parseInt(e.target.dataset.rating));
                        renderLoggingSection(); // Re-render to update star colors
                    };
                    workoutRatingStarsEl.appendChild(starBtn);
                }
                workoutCommentEl.value = workoutComment;
            } else {
                loggingSection.classList.add('hidden');
            }
        };

        const renderWeightProgress = () => {
            if (weightLogs.length > 0) {
                let html = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 rounded-lg overflow-hidden">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider rounded-tl-lg">
                                        Date
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider rounded-tr-lg">
                                        Weight (kg/lbs)
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                `;
                weightLogs.forEach((log) => {
                    html += `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">
                                        ${new Date(log.date).toLocaleDateString()}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">
                                        ${log.weight}
                                    </td>
                                </tr>
                    `;
                });
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                weightProgressContent.innerHTML = html;
            } else {
                weightProgressContent.innerHTML = '<p class="text-gray-700 dark:text-gray-300">No weight entries yet. Log your weight after a workout!</p>';
            }
        };

        const renderWorkoutHistory = () => {
            if (workoutHistory.length > 0) {
                let html = '<div class="space-y-4">';
                workoutHistory.forEach((log) => {
                    html += `
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-sm border border-gray-100 dark:border-gray-600">
                            <p class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-1">
                                ${log.workoutName} on ${new Date(log.date).toLocaleDateString()}
                            </p>
                            <p class="text-gray-600 dark:text-gray-300 text-sm mb-2">
                                Rating: ${log.rating} / 5 stars
                            </p>
                            ${log.comment ? `<p class="text-gray-700 dark:text-gray-400 text-sm italic mb-2">"${log.comment}"</p>` : ''}
                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                <span class="font-bold">Exercises:</span>
                                <ul class="list-disc list-inside ml-2">
                    `;
                    for (const exerciseId in log.exercisesPerformed) {
                        const details = log.exercisesPerformed[exerciseId];
                        const exName = EXERCISES_DATA.find(e => e.id === exerciseId)?.name || exerciseId;
                        html += `
                                    <li>
                                        ${exName} ${details.weight ? `(Weight: ${details.weight})` : ''}
                                    </li>
                        `;
                    }
                    html += `
                                </ul>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                workoutHistoryContent.innerHTML = html;
            } else {
                workoutHistoryContent.innerHTML = '<p class="text-gray-700 dark:text-gray-300">No workout logs yet. Complete a workout to see your history!</p>';
            }
        };

        const updateUI = () => {
            renderDailyWorkout();
            renderActiveWorkout();
            renderLoggingSection();
            renderWeightProgress();
            renderWorkoutHistory();
        };

        // --- State Updaters (mimicking React useState) ---
        const setWeightInput = (value) => {
            weightInput = value;
            if (activeWorkout === 'in-progress') {
                weightInputEl.value = weightInput; // Update input field directly
            }
        };

        const setWorkoutRating = (value) => {
            workoutRating = value;
            // Re-render logging section to update star colors
            renderLoggingSection();
        };

        const setWorkoutComment = (value) => {
            workoutComment = value;
        };

        const setTimerState = (newTimer, newTimerActive) => {
            timer = newTimer;
            timerActive = newTimerActive;
            renderActiveWorkout(); // Re-render to update timer display
        };

        const setActiveWorkoutState = (newState) => {
            activeWorkout = newState;
            updateUI(); // Re-render all sections based on new activeWorkout state
        };

        const setCurrentExerciseIndex = (newIndex) => {
            currentExerciseIndex = newIndex;
            renderActiveWorkout(); // Re-render active workout section
        };

        // --- Workout Logic ---
        let timerInterval = null;

        const startTimer = () => {
            setTimerState(45, true);
            showModalMessage("Rest for 45 seconds...");
            timerInterval = setInterval(() => {
                if (timer > 0) {
                    setTimerState(timer - 1, true);
                } else {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    setTimerState(0, false);
                    showModalMessage("Time for the next exercise!");
                }
            }, 1000);
        };

        const startWorkout = () => {
            setActiveWorkoutState('in-progress');
            setCurrentExerciseIndex(0);
            workoutLog = {}; // Reset log for new workout
            workoutRating = 0;
            workoutComment = '';
            weightInput = '';
            weightInputEl.value = ''; // Clear input field
            workoutCommentEl.value = ''; // Clear comment field
        };

        const handleDoneExercise = () => {
            if (workoutForToday && workoutForToday.exercises[currentExerciseIndex]) {
                const exerciseId = workoutForToday.exercises[currentExerciseIndex].id;
                workoutLog = {
                    ...workoutLog,
                    [exerciseId]: {
                        weight: weightInputEl.value, // Get current value from input
                    }
                };
                setWeightInput(''); // Clear weight input for next exercise
            }

            if (currentExerciseIndex < workoutForToday.exercises.length - 1) {
                setCurrentExerciseIndex(currentExerciseIndex + 1);
                startTimer();
            } else {
                setActiveWorkoutState('logging'); // Move to logging phase
                showModalMessage("Workout completed! Now log your overall details.");
            }
        };

        const submitWorkoutLog = async () => {
            if (!db || !userId) {
                console.error("Firestore not initialized or user not logged in.");
                showModalMessage("Error: Could not save workout. Please try again.");
                return;
            }

            try {
                const workoutsColRef = collection(db, `artifacts/${__app_id}/users/${userId}/workouts`);
                await addDoc(workoutsColRef, {
                    date: todayDate,
                    dayOfWeek: currentDay,
                    workoutName: workoutForToday.name,
                    exercisesPerformed: workoutLog,
                    rating: workoutRating,
                    comment: workoutCommentEl.value, // Get current value from textarea
                    timestamp: new Date(),
                });

                // Log daily weight if provided
                if (weightInputEl.value) { // Check input field value
                    const weightDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/weight_progress`, todayDate);
                    await setDoc(weightDocRef, {
                        date: todayDate,
                        weight: parseFloat(weightInputEl.value),
                        timestamp: new Date(),
                    }, { merge: true }); // Use merge to update if already exists
                }

                showModalMessage("Workout and weight logged successfully!");
                setActiveWorkoutState(null); // Go back to main view
                workoutLog = {};
                workoutRating = 0;
                workoutComment = '';
                weightInput = '';
                weightInputEl.value = ''; // Clear input field
                workoutCommentEl.value = ''; // Clear comment field
            } catch (error) {
                console.error("Error submitting workout log:", error);
                showModalMessage(`Error saving workout: ${error.message}`);
            }
        };

        // --- Firebase Initialization ---
        const initFirebase = async () => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                            userId = auth.currentUser?.uid || crypto.randomUUID(); // Ensure userId is set after auth
                        } catch (error) {
                            console.error("Firebase authentication error:", error);
                            userId = crypto.randomUUID(); // Fallback to a random UUID
                        }
                    }
                    isAuthReady = true;
                    userIdDisplay.textContent = `User ID: ${userId || 'N/A'}`;
                    initializeFirestoreListeners(); // Start listening to Firestore once auth is ready
                    updateUI(); // Initial UI render after auth
                });
            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                isAuthReady = true; // Ensure app can still render even if Firebase fails
                userId = crypto.randomUUID(); // Provide a fallback userId
                userIdDisplay.textContent = `User ID: ${userId || 'N/A'}`;
                updateUI(); // Initial UI render even if Firebase fails
            }
        };

        const initializeFirestoreListeners = () => {
            if (!db || !userId || !isAuthReady) return;

            // Pre-populate exercises collection if empty
            const populateExercises = async () => {
                try {
                    const exercisesColRef = collection(db, `artifacts/${__app_id}/public/data/exercises`);
                    const snapshot = await getDocs(exercisesColRef);
                    if (snapshot.empty) {
                        console.log("Populating exercises collection...");
                        for (const exercise of EXERCISES_DATA) {
                            await setDoc(doc(exercisesColRef, exercise.id), exercise);
                        }
                        console.log("Exercises populated.");
                    }
                } catch (error) {
                    console.error("Error populating exercises:", error);
                }
            };
            populateExercises();

            // Fetch workout history
            const workoutsColRef = collection(db, `artifacts/${__app_id}/users/${userId}/workouts`);
            onSnapshot(workoutsColRef, (snapshot) => {
                const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                logs.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date descending
                workoutHistory = logs;
                renderWorkoutHistory();
            }, (error) => console.error("Error fetching workout history:", error));

            // Fetch weight logs
            const weightColRef = collection(db, `artifacts/${__app_id}/users/${userId}/weight_progress`);
            onSnapshot(weightColRef, (snapshot) => {
                const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                logs.sort((a, b) => new Date(a.date) - new Date(b.date)); // Sort by date ascending for chart
                weightLogs = logs;
                renderWeightProgress();
            }, (error) => console.error("Error fetching weight logs:", error));
        };

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            currentDay = getDayOfWeek(getTodayDateString());
            workoutForToday = WORKOUT_PLAN[currentDay];

            initFirebase(); // Initialize Firebase and start auth listener

            // Initial render state
            updateUI();

            // Attach event listeners to buttons
            // Note: startWorkoutBtn is dynamic, so its listener is attached in renderDailyWorkout
            doneExerciseBtn.addEventListener('click', handleDoneExercise);
            submitLogBtn.addEventListener('click', submitWorkoutLog);
            modalMessageOkBtn.addEventListener('click', hideModalMessage);

            // Input change listeners
            weightInputEl.addEventListener('input', (e) => setWeightInput(e.target.value));
            workoutCommentEl.addEventListener('input', (e) => setWorkoutComment(e.target.value));
        });
    </script>
</body>
</html>
